name: Bazel Targets Scan

on:
  pull_request:
  push:
    branches: [main]

jobs:
  detect-and-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: pr
      
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: master
          path: base
        
      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true

      - name: Install bazel-diff
        run: |
          curl -Lo bazel-diff.jar https://github.com/Tinder/bazel-diff/releases/latest/download/bazel-diff_deploy.jar
          java -jar bazel-diff.jar -h
      
      - name: Bazel-diff Generate Hashes For PR
        run: |
          java -jar bazel-diff.jar  generate-hashes --workspacePath pr --bazelPath $(which bazel) final-hashes.json

      - name: Bazel-diff Generate Hashes For Base
        run: |
          java -jar bazel-diff.jar  generate-hashes --workspacePath base --bazelPath $(which bazel) starting-hashes.json

      - name: Get Impacted Targets
        run: |
          java -jar bazel-diff.jar get-impacted-targets -sh starting-hashes.json -fh final-hashes.json -o impacted-tagets
          cat impacted-targets
          
      - name: Filter for go_binary Targets
        id: go-binaries
        run:
          impacted=$(cat impacted-targets)
          echo "$impacted" | xargs bazel query 'kind("go_binary", set(^$))' > go-binary.txt
          cat go-binary.txt
          go_binaries=$(sed '/^$/d; s/^/"/; s/$/"/' go-binary.txt | paste -sd, -)
          go_binaries="[$go_binaries]"
          
          
  
      # - name: Endor Scan Targets
      #   if: steps.set-targets.outputs.targets != ''
      #   uses: endorlabs/github-action@main
      #   with: 
      #     namespace: 'kriti-learn'
      #     scan_dependencies: true
      #     pr: false
      #     scan_summary_output_type: 'table'
      #     additional_args: "--bazel-include-targets=${{ steps.set-targets.outputs.targets }}"
